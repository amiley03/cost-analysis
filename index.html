<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costing Forecast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #fff;
            font-size: 28px;
        }

        .login-box .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .login-box input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4a9eff 0%, #6366f1 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 158, 255, 0.3);
        }

        .login-error {
            color: #ff6b6b;
            text-align: center;
            margin-top: 12px;
            font-size: 14px;
            display: none;
        }

        /* Main App */
        #main-app {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        header h1 {
            font-size: 24px;
            color: #fff;
        }

        header button {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            background: linear-gradient(135deg, #4a9eff 0%, #6366f1 100%);
            color: #fff;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .badge {
            font-size: 12px;
            padding: 4px 8px;
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
            border-radius: 4px;
            font-weight: 500;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-size: 13px;
            color: #888;
        }

        .input-group input, .input-group select {
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 14px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .input-group input.editable {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .metric {
            background: rgba(255,255,255,0.03);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .metric .label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .metric .value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .metric .value.positive {
            color: #22c55e;
        }

        .metric .value.negative {
            color: #ef4444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        th {
            color: #888;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th:first-child, td:first-child {
            text-align: left;
        }

        td.positive {
            color: #22c55e;
        }

        td.negative {
            color: #ef4444;
        }

        .month-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto;
        }

        /* Transfer Pricing Styles */
        .channel-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .channel-card h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #fff;
        }

        .pricing-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
        }

        .pricing-row.header {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 12px;
            margin-bottom: 8px;
        }

        .flag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .flag.ok {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .flag.warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .flag.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            color: #888;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.yellow {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .legend-color.green {
            background: rgba(34, 197, 94, 0.3);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        @media (max-width: 768px) {
            .pricing-row {
                grid-template-columns: 1fr 1fr;
            }

            .pricing-row.header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <h1>Costing Forecast</h1>
            <p class="subtitle">Product Margin Analysis</p>
            <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key === 'Enter') login()">
            <button onclick="login()">Access Dashboard</button>
            <p class="login-error" id="login-error">Incorrect password. Please try again.</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app">
        <header>
            <h1>Costing Forecast Dashboard</h1>
            <button onclick="logout()">Logout</button>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('scenario')">Scenario Planner</div>
            <div class="tab" onclick="switchTab('pricing')">Transfer & Retail Pricing</div>
        </div>

        <!-- Scenario Planner Tab -->
        <div id="scenario-tab" class="tab-content active">
            <div class="card">
                <h2>Scenario Inputs <span class="badge">Editable</span></h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Annual Lbs (Scenario)</label>
                        <input type="number" id="annualLbs" class="editable" value="638205" onchange="recalculate()">
                    </div>
                    <div class="input-group">
                        <label>14oz Tray Share %</label>
                        <input type="number" id="trayShare" class="editable" value="0" min="0" max="100" onchange="recalculate()">
                    </div>
                    <div class="input-group">
                        <label>Labor Fixed %</label>
                        <input type="number" id="laborFixed" class="editable" value="30" min="0" max="100" onchange="recalculate()">
                    </div>
                    <div class="input-group">
                        <label>Overhead Fixed %</label>
                        <input type="number" id="overheadFixed" class="editable" value="30" min="0" max="100" onchange="recalculate()">
                    </div>
                    <div class="input-group">
                        <label>Freight Fixed %</label>
                        <input type="number" id="freightFixed" class="editable" value="0" min="0" max="100" onchange="recalculate()">
                    </div>
                    <div class="input-group">
                        <label>Target GM % (optional)</label>
                        <input type="number" id="targetGM" class="editable" value="0" min="0" max="100" onchange="recalculate()">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Annual Summary</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="label">Annual Revenue</div>
                        <div class="value" id="totalRevenue">$0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Annual Total Cost</div>
                        <div class="value" id="totalCost">$0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Annual Gross Margin</div>
                        <div class="value" id="totalGM">$0</div>
                    </div>
                    <div class="metric">
                        <div class="label">GM %</div>
                        <div class="value" id="gmPercent">0%</div>
                    </div>
                    <div class="metric">
                        <div class="label">GM$ Variance vs Baseline</div>
                        <div class="value" id="varianceTotal">$0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Meets Target GM?</div>
                        <div class="value" id="meetsTarget">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Monthly Breakdown <span class="badge">Toggle 14oz Production</span></h2>
                <p style="font-size: 13px; color: #888; margin-bottom: 16px;">Check boxes to enable 14oz production in each month. Default: Jul-Aug & Oct-Dec.</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>14oz On</th>
                                <th>Total Lbs</th>
                                <th>Revenue</th>
                                <th>Total Cost</th>
                                <th>Gross Margin</th>
                                <th>GM %</th>
                                <th>Variance</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTable">
                            <!-- Populated by JS -->
                        </tbody>
                        <tfoot id="monthlyTotals">
                            <!-- Populated by JS -->
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>Cost Scaling Summary</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="label">Labor $/lb</div>
                        <div class="value" id="laborPerLb">$0.00</div>
                    </div>
                    <div class="metric">
                        <div class="label">Overhead $/lb</div>
                        <div class="value" id="overheadPerLb">$0.00</div>
                    </div>
                    <div class="metric">
                        <div class="label">Freight $/lb</div>
                        <div class="value" id="freightPerLb">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transfer Pricing Tab -->
        <div id="pricing-tab" class="tab-content">
            <div class="card">
                <h2>Channel Assumptions <span class="badge">Editable</span></h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Safeway Retail GM %</label>
                        <input type="number" id="safewayGM" class="editable" value="30" min="0" max="100" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>CVS Retail GM %</label>
                        <input type="number" id="cvsGM" class="editable" value="35" min="0" max="100" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>Distributor GM %</label>
                        <input type="number" id="distributorGM" class="editable" value="25" min="0" max="100" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>Manufacturer Target GM %</label>
                        <input type="number" id="mfgTargetGM" class="editable" value="30" min="0" max="100" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>Costco Markup %</label>
                        <input type="number" id="costcoMarkup" class="editable" value="14" min="0" max="100" onchange="recalculatePricing()">
                    </div>
                </div>
                <div class="input-grid" style="margin-top: 16px;">
                    <div class="input-group">
                        <label>Safeway $/oz Target</label>
                        <input type="number" id="safewayPerOz" class="editable" value="2.80" step="0.01" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>CVS $/oz Target</label>
                        <input type="number" id="cvsPerOz" class="editable" value="3.00" step="0.01" onchange="recalculatePricing()">
                    </div>
                    <div class="input-group">
                        <label>Costco $/oz Target</label>
                        <input type="number" id="costcoPerOz" class="editable" value="1.05" step="0.01" onchange="recalculatePricing()">
                    </div>
                </div>
            </div>

            <!-- Costco Pricing -->
            <div class="card">
                <h2>Costco (Direct)</h2>
                <div class="channel-card">
                    <div class="pricing-row header">
                        <div>Product</div>
                        <div>COGS/Unit</div>
                        <div>Target SRP</div>
                        <div>Suggested Transfer</div>
                        <div>Status</div>
                    </div>
                    <div id="costco-products">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Safeway Pricing -->
            <div class="card">
                <h2>Safeway (via Distributor)</h2>
                <div class="channel-card">
                    <div class="pricing-row header">
                        <div>Product</div>
                        <div>COGS/Unit</div>
                        <div>Target SRP</div>
                        <div>Suggested Transfer</div>
                        <div>Status</div>
                    </div>
                    <div id="safeway-products">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- CVS Pricing -->
            <div class="card">
                <h2>CVS (via Distributor)</h2>
                <div class="channel-card">
                    <div class="pricing-row header">
                        <div>Product</div>
                        <div>COGS/Unit</div>
                        <div>Target SRP</div>
                        <div>Suggested Transfer</div>
                        <div>Status</div>
                    </div>
                    <div id="cvs-products">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Pricing Formula Reference</h2>
                <p style="font-size: 13px; color: #888; line-height: 1.8;">
                    <strong>Safeway/CVS (through distributor):</strong><br>
                    Retail Cost = SRP × (1 – Retail GM%)<br>
                    Max Mfg→Dist Transfer = Retail Cost × (1 – Distributor GM%)<br><br>
                    <strong>Costco (direct):</strong><br>
                    Max Mfg Price = SRP ÷ (1 + Costco Markup%)
                </p>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color yellow"></div>
                        <span>Editable inputs</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color green"></div>
                        <span>Suggested transfer prices</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - CHANGE THIS PASSWORD
        const SITE_PASSWORD = 'bearbear2026';

        // Baseline data from spreadsheet
        const BASELINE = {
            lbs: 638204.76,
            laborAnnual: 261459,
            overheadAnnual: 201853,
            freightAnnual: 40894
        };

        // Product sizes with their data
        const PRODUCTS = [
            { size: 1, mixPct: 0.001, transfer: 0.99, nonLOF: 0.56 },
            { size: 1.5, mixPct: 0.001, transfer: 1.48, nonLOF: 0.84 },
            { size: 2, mixPct: 0.002, transfer: 1.98, nonLOF: 1.11 },
            { size: 2.5, mixPct: 0.15, transfer: 2.75, nonLOF: 1.49 },
            { size: 2.75, mixPct: 0.001, transfer: 2.72, nonLOF: 1.53 },
            { size: 2.85, mixPct: 0.001, transfer: 2.81, nonLOF: 1.59 },
            { size: 5, mixPct: 0.001, transfer: 4.94, nonLOF: 2.79 },
            { size: 6, mixPct: 0.25, transfer: 5.25, nonLOF: 3.11 },
            { size: 8, mixPct: 0.05, transfer: 6.14, nonLOF: 4.17 },
            { size: 9, mixPct: 0.001, transfer: 6.91, nonLOF: 4.69 },
            { size: 12, mixPct: 0.20, transfer: 9.00, nonLOF: 6.64 },
            { size: 14, mixPct: 0.30, transfer: 11.00, nonLOF: 6.85 },
            { size: 16, mixPct: 0.04, transfer: 12.29, nonLOF: 8.34 }
        ];

        // Products for transfer pricing
        const PRICING_PRODUCTS = [
            { name: 'Original Beef 2.5oz Bag', size: 2.5, cogs: 2.12 },
            { name: 'Original Beef 6oz Bag', size: 6, cogs: 4.58 },
            { name: 'Original Beef 12oz Bag', size: 12, cogs: 8.47 },
            { name: 'Original Beef 14oz Bag', size: 14, cogs: 9.82 },
            { name: 'Original Beef 14oz Tray', size: 14, cogs: 10.12 },
            { name: 'Sweet Beef 2.5oz Bag', size: 2.5, cogs: 2.18 },
            { name: 'Sweet Beef 6oz Bag', size: 6, cogs: 4.72 },
            { name: 'Sweet Beef 8oz Bag', size: 8, cogs: 6.15 },
            { name: 'Sweet Beef 12oz Bag', size: 12, cogs: 8.72 },
            { name: 'Sweet Beef 14oz Bag', size: 14, cogs: 10.08 },
            { name: 'Sweet Beef 14oz Tray', size: 14, cogs: 10.38 }
        ];

        // Months with default 14oz multipliers
        const MONTHS = [
            { name: 'Jan', seasonality: 1/12, mult14: false },
            { name: 'Feb', seasonality: 1/12, mult14: false },
            { name: 'Mar', seasonality: 1/12, mult14: false },
            { name: 'Apr', seasonality: 1/12, mult14: false },
            { name: 'May', seasonality: 1/12, mult14: false },
            { name: 'Jun', seasonality: 1/12, mult14: false },
            { name: 'Jul', seasonality: 1/12, mult14: true },
            { name: 'Aug', seasonality: 1/12, mult14: true },
            { name: 'Sep', seasonality: 1/12, mult14: false },
            { name: 'Oct', seasonality: 1/12, mult14: true },
            { name: 'Nov', seasonality: 1/12, mult14: true },
            { name: 'Dec', seasonality: 1/12, mult14: true }
        ];

        // Login functions
        function login() {
            const pwd = document.getElementById('password').value;
            if (pwd === SITE_PASSWORD) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                sessionStorage.setItem('authenticated', 'true');
                recalculate();
                recalculatePricing();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('authenticated');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        function checkAuth() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                recalculate();
                recalculatePricing();
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (tab === 'scenario') {
                document.querySelector('.tabs .tab:first-child').classList.add('active');
                document.getElementById('scenario-tab').classList.add('active');
            } else {
                document.querySelector('.tabs .tab:last-child').classList.add('active');
                document.getElementById('pricing-tab').classList.add('active');
            }
        }

        // Format currency
        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatCurrencyDecimal(value) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatPercent(value) {
            return (value * 100).toFixed(1) + '%';
        }

        // Main calculation
        function recalculate() {
            const annualLbs = parseFloat(document.getElementById('annualLbs').value) || 0;
            const trayShare = parseFloat(document.getElementById('trayShare').value) / 100 || 0;
            const laborFixed = parseFloat(document.getElementById('laborFixed').value) / 100 || 0;
            const overheadFixed = parseFloat(document.getElementById('overheadFixed').value) / 100 || 0;
            const freightFixed = parseFloat(document.getElementById('freightFixed').value) / 100 || 0;
            const targetGM = parseFloat(document.getElementById('targetGM').value) / 100 || 0;

            // Calculate scaled costs
            const scenarioLabor = (BASELINE.laborAnnual * laborFixed) +
                ((BASELINE.laborAnnual * (1 - laborFixed)) / BASELINE.lbs) * annualLbs;
            const scenarioOverhead = (BASELINE.overheadAnnual * overheadFixed) +
                ((BASELINE.overheadAnnual * (1 - overheadFixed)) / BASELINE.lbs) * annualLbs;
            const scenarioFreight = (BASELINE.freightAnnual * freightFixed) +
                ((BASELINE.freightAnnual * (1 - freightFixed)) / BASELINE.lbs) * annualLbs;

            const laborPerLb = annualLbs > 0 ? scenarioLabor / annualLbs : 0;
            const overheadPerLb = annualLbs > 0 ? scenarioOverhead / annualLbs : 0;
            const freightPerLb = annualLbs > 0 ? scenarioFreight / annualLbs : 0;

            // Update cost scaling display
            document.getElementById('laborPerLb').textContent = formatCurrencyDecimal(laborPerLb);
            document.getElementById('overheadPerLb').textContent = formatCurrencyDecimal(overheadPerLb);
            document.getElementById('freightPerLb').textContent = formatCurrencyDecimal(freightPerLb);

            // Get month toggles
            const monthToggles = [];
            document.querySelectorAll('.month-checkbox').forEach((cb, i) => {
                monthToggles[i] = cb.checked;
            });

            // Calculate monthly data
            let totalRevenue = 0;
            let totalCost = 0;
            let totalGM = 0;
            let totalBaselineGM = 0;

            const monthlyData = MONTHS.map((month, i) => {
                const mult14 = monthToggles.length > 0 ? monthToggles[i] : month.mult14;
                const monthLbs = annualLbs * month.seasonality;

                // Calculate mix denominator (sum of mix% adjusted for 14oz)
                let mixDenom = PRODUCTS.reduce((sum, p) => {
                    if (p.size === 14) {
                        return sum + (mult14 ? p.mixPct : 0);
                    }
                    return sum + p.mixPct;
                }, 0);

                if (mixDenom === 0) mixDenom = 1;

                // Calculate revenue and non-LOF cost
                let revenue = 0;
                let nonLOFCost = 0;

                PRODUCTS.forEach(p => {
                    let effectiveMix = p.mixPct;
                    if (p.size === 14 && !mult14) {
                        effectiveMix = 0;
                    }

                    const lbPerUnit = p.size / 16;
                    const unitLbs = (monthLbs / mixDenom) * effectiveMix;
                    const units = unitLbs / lbPerUnit;

                    revenue += units * p.transfer;
                    nonLOFCost += units * p.nonLOF;
                });

                const laborCost = monthLbs * laborPerLb;
                const overheadCost = monthLbs * overheadPerLb;
                const freightCost = monthLbs * freightPerLb;
                const totalMonthCost = nonLOFCost + laborCost + overheadCost + freightCost;
                const grossMargin = revenue - totalMonthCost;
                const gmPct = revenue > 0 ? grossMargin / revenue : 0;

                // Baseline calculation (14oz always on)
                let baselineMixDenom = PRODUCTS.reduce((sum, p) => sum + p.mixPct, 0);
                if (baselineMixDenom === 0) baselineMixDenom = 1;

                let baselineRevenue = 0;
                let baselineNonLOFCost = 0;

                PRODUCTS.forEach(p => {
                    const lbPerUnit = p.size / 16;
                    const unitLbs = (monthLbs / baselineMixDenom) * p.mixPct;
                    const units = unitLbs / lbPerUnit;

                    baselineRevenue += units * p.transfer;
                    baselineNonLOFCost += units * p.nonLOF;
                });

                const baselineTotalCost = baselineNonLOFCost + laborCost + overheadCost + freightCost;
                const baselineGM = baselineRevenue - baselineTotalCost;
                const variance = grossMargin - baselineGM;

                totalRevenue += revenue;
                totalCost += totalMonthCost;
                totalGM += grossMargin;
                totalBaselineGM += baselineGM;

                return {
                    name: month.name,
                    mult14,
                    lbs: monthLbs,
                    revenue,
                    cost: totalMonthCost,
                    gm: grossMargin,
                    gmPct,
                    variance
                };
            });

            // Update summary metrics
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalGM').textContent = formatCurrency(totalGM);

            const overallGMPct = totalRevenue > 0 ? totalGM / totalRevenue : 0;
            document.getElementById('gmPercent').textContent = formatPercent(overallGMPct);

            const totalVariance = totalGM - totalBaselineGM;
            const varianceEl = document.getElementById('varianceTotal');
            varianceEl.textContent = formatCurrency(totalVariance);
            varianceEl.className = 'value ' + (totalVariance >= 0 ? 'positive' : 'negative');

            const meetsTargetEl = document.getElementById('meetsTarget');
            if (targetGM === 0) {
                meetsTargetEl.textContent = '-';
                meetsTargetEl.className = 'value';
            } else if (overallGMPct >= targetGM) {
                meetsTargetEl.textContent = 'YES';
                meetsTargetEl.className = 'value positive';
            } else {
                meetsTargetEl.textContent = 'NO';
                meetsTargetEl.className = 'value negative';
            }

            // Update monthly table
            const tbody = document.getElementById('monthlyTable');
            tbody.innerHTML = monthlyData.map((m, i) => `
                <tr>
                    <td>${m.name}</td>
                    <td class="month-toggle">
                        <input type="checkbox" class="month-checkbox" ${m.mult14 ? 'checked' : ''} onchange="recalculate()">
                    </td>
                    <td>${m.lbs.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td>${formatCurrency(m.revenue)}</td>
                    <td>${formatCurrency(m.cost)}</td>
                    <td class="${m.gm >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.gm)}</td>
                    <td class="${m.gmPct >= 0.2 ? 'positive' : ''}">${formatPercent(m.gmPct)}</td>
                    <td class="${m.variance >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.variance)}</td>
                </tr>
            `).join('');

            // Update totals row
            document.getElementById('monthlyTotals').innerHTML = `
                <tr style="font-weight: 600; border-top: 2px solid rgba(255,255,255,0.2);">
                    <td>TOTAL</td>
                    <td></td>
                    <td>${annualLbs.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td>${formatCurrency(totalRevenue)}</td>
                    <td>${formatCurrency(totalCost)}</td>
                    <td class="${totalGM >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalGM)}</td>
                    <td>${formatPercent(overallGMPct)}</td>
                    <td class="${totalVariance >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalVariance)}</td>
                </tr>
            `;
        }

        // Transfer pricing calculation
        function recalculatePricing() {
            const safewayGM = parseFloat(document.getElementById('safewayGM').value) / 100;
            const cvsGM = parseFloat(document.getElementById('cvsGM').value) / 100;
            const distributorGM = parseFloat(document.getElementById('distributorGM').value) / 100;
            const mfgTargetGM = parseFloat(document.getElementById('mfgTargetGM').value) / 100;
            const costcoMarkup = parseFloat(document.getElementById('costcoMarkup').value) / 100;

            const safewayPerOz = parseFloat(document.getElementById('safewayPerOz').value);
            const cvsPerOz = parseFloat(document.getElementById('cvsPerOz').value);
            const costcoPerOz = parseFloat(document.getElementById('costcoPerOz').value);

            // Costco pricing
            let costcoHTML = '';
            PRICING_PRODUCTS.forEach(p => {
                const targetSRP = Math.ceil(p.size * costcoPerOz * 100) / 100;
                const maxMfgPrice = targetSRP / (1 + costcoMarkup);
                const minPriceForGM = p.cogs / (1 - mfgTargetGM);
                const suggestedTransfer = Math.min(maxMfgPrice, minPriceForGM);
                const impliedGM = 1 - (p.cogs / suggestedTransfer);

                let flag, flagClass;
                if (p.cogs > maxMfgPrice) {
                    flag = 'SRP too low';
                    flagClass = 'error';
                } else if (suggestedTransfer < minPriceForGM) {
                    flag = 'Below target GM';
                    flagClass = 'warning';
                } else {
                    flag = 'OK';
                    flagClass = 'ok';
                }

                costcoHTML += `
                    <div class="pricing-row">
                        <div>${p.name}</div>
                        <div>${formatCurrencyDecimal(p.cogs)}</div>
                        <div>${formatCurrencyDecimal(targetSRP)}</div>
                        <div style="color: #22c55e;">${formatCurrencyDecimal(suggestedTransfer)}</div>
                        <div><span class="flag ${flagClass}">${flag}</span></div>
                    </div>
                `;
            });
            document.getElementById('costco-products').innerHTML = costcoHTML;

            // Safeway pricing
            let safewayHTML = '';
            PRICING_PRODUCTS.forEach(p => {
                const targetSRP = Math.ceil(p.size * safewayPerOz * 100) / 100;
                const retailCost = targetSRP * (1 - safewayGM);
                const maxTransfer = retailCost * (1 - distributorGM);
                const minPriceForGM = p.cogs / (1 - mfgTargetGM);
                const suggestedTransfer = Math.min(maxTransfer, minPriceForGM);

                let flag, flagClass;
                if (p.cogs > maxTransfer) {
                    flag = 'SRP too low';
                    flagClass = 'error';
                } else if (suggestedTransfer < minPriceForGM) {
                    flag = 'Below target GM';
                    flagClass = 'warning';
                } else {
                    flag = 'OK';
                    flagClass = 'ok';
                }

                safewayHTML += `
                    <div class="pricing-row">
                        <div>${p.name}</div>
                        <div>${formatCurrencyDecimal(p.cogs)}</div>
                        <div>${formatCurrencyDecimal(targetSRP)}</div>
                        <div style="color: #22c55e;">${formatCurrencyDecimal(suggestedTransfer)}</div>
                        <div><span class="flag ${flagClass}">${flag}</span></div>
                    </div>
                `;
            });
            document.getElementById('safeway-products').innerHTML = safewayHTML;

            // CVS pricing
            let cvsHTML = '';
            PRICING_PRODUCTS.forEach(p => {
                const targetSRP = Math.ceil(p.size * cvsPerOz * 100) / 100;
                const retailCost = targetSRP * (1 - cvsGM);
                const maxTransfer = retailCost * (1 - distributorGM);
                const minPriceForGM = p.cogs / (1 - mfgTargetGM);
                const suggestedTransfer = Math.min(maxTransfer, minPriceForGM);

                let flag, flagClass;
                if (p.cogs > maxTransfer) {
                    flag = 'SRP too low';
                    flagClass = 'error';
                } else if (suggestedTransfer < minPriceForGM) {
                    flag = 'Below target GM';
                    flagClass = 'warning';
                } else {
                    flag = 'OK';
                    flagClass = 'ok';
                }

                cvsHTML += `
                    <div class="pricing-row">
                        <div>${p.name}</div>
                        <div>${formatCurrencyDecimal(p.cogs)}</div>
                        <div>${formatCurrencyDecimal(targetSRP)}</div>
                        <div style="color: #22c55e;">${formatCurrencyDecimal(suggestedTransfer)}</div>
                        <div><span class="flag ${flagClass}">${flag}</span></div>
                    </div>
                `;
            });
            document.getElementById('cvs-products').innerHTML = cvsHTML;
        }

        // Initialize on page load
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>
